# Инстанс сегментация рентгеновских снимков позвоночника
---------------------------------------------------------
### Цель работы
- Обучение модели нейросети на распознавание позвонков человека
### Задачи
1. Найти датасеты, содержащие подходящие данные и разметку
2. Выбрать модель нейросети
3. Обучить нейросеть
4. Проанализировать работу обученной модели
5. Написать план по развитию проекта для определения остохандроза
------------------------------------------------------------
## Датасеты
Для поиска датасетов были использванны следующие ресурсы:
- [Roboflow](https://roboflow.com/)
- [Kaggle](https://www.kaggle.com/)
- [Hugging Face](https://huggingface.co/)


На Roboflow были найдены 2 датасета с подходящими данными:
- [Scoliosis Computer Vision Dataset](https://universe.roboflow.com/mimitlab/scoliosis-gnlbf)
- [Cervical Segmentation Computer Vision Dataset](https://universe.roboflow.com/sha-dw5z0/cervical-segmentation-eoxax)

Данные датасетов были расширенны `переворотами`, `поворотом на  90 градусов` и `вращением` при помощи `Augmentation Options` доступной на Roboflow.
Также на Roboflow есть возможность скачать датасеты с изменением данных(`.yaml`,`.json`,`.csv` и т.д.), необходимых для обучения, под конкретную модель, что в дальнейшем было использовано.

Далее датасеты были объеденены и конечный датасет будет использован для обучения модели.

--------------------------------------------------------

## Модель нейросети
На этапе выбора модели нейросети были выдвинуты следующие критерии:
- Точность определения
- Скорость обучения и работы
- Ресурсозатратность

Далее были рассмотренны следующие модели по критериям выше

|             **Модель**               |     **Точность**      |    **Скорость**   | **Ресурсозатратность** |
| :----------------------------------: | :-------------------: | :---------------: | :----------------: |
|           Mask R-CNN                 |        Высокая        |     Медленная     |    Очень высокая   |
|          YOLOv11-seg                 |        Высокая        |   Очень высокая   |       Низкая       | 
|          Mask2Former                 |    State-of-the-art   |   Средняя/низкая  |  Умеренно высокая  |
|    Segment Anything Model (SAM)      |    State-of-the-art   |    Очень низкая   |    Очень высокая   | 

Исходя из таблице выше выбор пал на ``YOLOv11-seg``.

------------------------------------------------------

## Обучение модели
Для обучения была взята модель YOLOv11n-seg, где `n` - размер модели.

Обучение проходило на изображениях размером `640x640`, за один раз подавадлось 16 изображений (`batch = 16`) и количество эпох равно 250 (`epochs = 250`).

---------------------------------------------------

## Результаты обучения
Пример выполнения инстанс сегментации обученой модели:
|**Позвонки шейного отдела(С1-С7)**|**Позвонки грудного и поясничного отделов(T1-T12, L1-L5)**|
|:----------------------------------:|:-------------------------------------------------------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/data/result/0111122_png.rf.19859110a93dc0f021a332e1ff17fe56.jpg_result.jpg "Шейный отдел")|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/data/result/01-July-2019-83_jpg.rf.9f3e9abbe168061df8dc544b1646af54.jpg_result.jpg "Грудной и поясничный отделы")|

## Анализ метрик после обучения модели
### Предсказание(Precision)
| **BoxP** | **MaskP** |
|:---------:|:----------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/BoxP_curve.png "BoxP curve") | ![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/BoxP_curve.png "BoxP curve") |
|Предсказание для прямоуголников по всем классам равно 1.00 при уверенности 0.943, однако, как видно из графика, некоторые из классов при определённой уверености(`от 0.83 до 0.92`) будут предсказываться значительно хуже.| Предсказание для сегментации по всем классам равно 1.00 при уверенности 0.943, однако, как видно из графика, некоторые из классов при определённой уверености(`от 0.83 до 0.92`) будут предсказываться значительно хуже.|

### Полнота(Recall)
| **BoxR** | **MaskR** |
|:---------:|:----------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/BoxR_curve.png "BoxR curve") | ![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/MaskR_curve.png "MaskR curve") |
| Полнота для прямоугольников по всем классам равна 0.98 при уверенности 0.00, исследуя график дальше можно заметить, что с ростом уверености, падает полнота и при уверенности 1.00, полнота равна 0.00. После достижения уверености равной 0.7 теряется один из классов. | Полнота для сегментации по всем классам равна 0.97 при уверенности 0.00, исследуя график дальше можно заметить, что с ростом уверености, падает полнота и при уверенности 1.00, полнота равна 0.00. После достижения уверености равной 0.7 теряется один из классов.|

### Компромисс предсказания и полноты(Precision-Recall)
| **BoxPR** | **MaskPR** |
|:---------:|:----------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/BoxPR_curve.png "BoxPR curve") | ![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/MaskPR_curve.png "MaskPR curve")|
| Из данного графика можно узнать полную картину соотношения значения предсказания к значению полноты для прямоугольников. Для модели это пересечение кривой на точке равной 0.849. | Из данного графика можно узнать полную картину соотношения значения предсказания к значению полноты для сегментации. Для модели это пересечение кривой на точке равной 0.838. |

### F1-Score
| **BoxF1** | **MaskF1** |
|:---------:|:----------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/BoxF1_curve.png "BoxF1 curve") | ![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/MaskF1_curve.png "MaskF1 curve") |
| Из данного графика можно узнать оптимальное соотношение предсказания к значению полноты для прямоугольников. Для модели это пересечение F1 = 0.79(по всем классам) при уверености равной 0.257. | Из данного графика можно узнать оптимальное соотношение значения предсказания к значению полноты для сегментации. Для модели это пересечение F1 = 0.78(по всем классам) при уверености равной 0.258. |

### Матрица путаницы
| **Confusion Matrix** | **Confusion Matrix Normalized** |
|:---------:|:----------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/confusion_matrix.png "Confusion Matrix") | ![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/confusion_matrix_normalized.png "Confusion Matrix Normalized") |
| Из данного графика можно узнать сколько раз был правильно определён объект. Модель, для каждого класса, имеет предсказания background, а также ложные предсказания расположенных рядом классов. Также исходя из данных на этом графике видно, что классы неравномерно распределенны. | Данный график приводит данные прошлого графика, но уже в процентном соотношении. Исходя из этого, очевидно, что классы от T1-T12 и L1-L5 имеют высокий процент предсказания и низкий процент ложных предсказаний для соседних классов и background, но классы C1-C7 имеют противоположную ситуацию. Также исходя из данных на этом графике видно, что классы неравномерно распределенны. |

### Распределение классов
| Labels |
|:---------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/labels.jpg "Labels") | 
| Из диаграммы видно неравномерное распределенние классов. Графики ниже показывают рапределение объектов на изображениях датасета по осям X и Y, а также размеры объекта на изображении. По левому графику видно, что объекты практически равномерно были распределнны по изображению. Из правого графика следут, что объект чаще шире, чем выше|

### Графики эффективности обучения модели
| Метрики результатов обучения |
|:---------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/train%20result/results.png "Results Train") | 
|На данном рисунке представленны графики обучения и валидации модели в течении 250 эпох, а также метрики показывающие улучшения предсказания(`precision`), полноты(`recall`), mAP50 и mAP50-95  определения объектов и сегментанции. Из графиков обучения и валидации можно сделать вывод, что модель была хорошо обучена, однако всегда "теряется" один прямоугольник, сегмент и реже класс. Следующие метрики показывают высокие показатели предсказания(`precision`) и полноты(`recall`) для определения прямоугольников и сегментации. Метрика mAP50 показывает нам, что в 80% случаев наше предсказание считается правильным, но mAP-50-95 указывает на то,что только 55% предсказаний модели считаются верными. |

### Вывод об обученной модели
Таким образом, модель получилась не точной, тонкие настройки(`Precision = 0.8, Recall = 0.7, IoU = 0.55, Confidence = 0.7`) позволят добится стабильности работы и минимизировать часть ошибок модели, но при этом процент правильно предсказынных объектов не вырастет и всегда будет потерян один класс.

Такое могло произойти из-за качества датасетов и выбора размера модели. Объединёный датасет получился неравномерно распределённым по классам. Вероятно, разметка исходных датасетов была не точной и они не были нормализованны должним образом. Также на качество обучения повлиял размер модели, ведь чем выше размер обучаемой модели, тем она будет точнее.

## Определение остеохондроза
>Остеохондроз — это дегенеративно-дистрофическое заболевание, поражающее межпозвонковые диски, а затем и соседние тела позвонков.

Для опредления этой паталогии нужно привести классификацию и признаки.
### Классификация остеохондроза
1. По локализации
   * Шейный
   * Грудной
   * Поясничный
   * Крестцовый
   * Комбинированный
2. По степени изменения межпозвонковых дисков
   * Нулевая (При нулевой степени видимых поражений в позвоночном столбе не наблюдается.)
   * Первая (Внутренние разрывы дисков без внешних изменений.)
   * Вторая (Диск заметно изменяется без наружных повреждений.)
   * Третья (Межпозвоночный диск сильно поражается. При этом трещины распространяются на внутреннюю поверхность, а сам диск выдавливается из позвонков.)
3. По клиническим проявлениям
   * 1 стадия (Позвоночник продолжает функционировать, как обычно, однако человек чувствует незначительную боль в месте локализации заболевания.)
   * 2 стадия (Начинаются защемления нервов, протрузия, подвывих позвонков, при этом боль становится сильнее.)
   * 3 стадия (Боль усиливается, происходит деформация позвоночника, появляется грыжа позвонковых дисков.)
   * 4 стадия (Позвоночник теряет подвижность, боль возникает при любом движении, больной ходит с большим трудом.)
### Рентгенологические признаки остеохондроза
1. Прямые
   * Снижение высоты межпозвоночных дисков
     #### Классификация
     - Начальная стадия (1 стадия) — это первая стадия, на которой диск начинает терять влагу и становится менее эластичным. Обычно на этой стадии симптомы отсутствуют или незначительны.
     - Средняя стадия (2 стадия) — диск продолжает терять влагу, что приводит к дальнейшему снижению его высоты. Могут появиться боли в спине или другие симптомы, особенно при физической нагрузке.
     - Продвинутая стадия (3 стадия) — на этой стадии высота диска значительно снижается, что может привести к сдавливанию нервов и появлению симптомов, таких как острая боль, онемение или слабость в конечностях.
     - Критическая стадия (4 стадия) — самая серьезная стадия, на которой диск может быть практически полностью уничтожен. Боль и другие симптомы могут быть постоянными, и может понадобиться хирургическое вмешательство для облегчения симптомов.
2. Косвенные
   
   * Субхондральный склероз (`уплотнение костной ткани, расположенной непосредственно под суставным хрящом, возникающее в ответ на его повреждение и дегенерацию`)
     #### Классификация
     - Начальная степень – незначительное уплотнение костной ткани, изменения выявляются только при рентгенографии.
     - Умеренная степень – значительное утолщение субхондральной кости, сопровождаемое истончением хряща.
     - Тяжелая степень – выраженная деформация суставных поверхностей, практически полный износ хряща.
   
   * Остеофиты (`патологический нарост (экзостоз), который образуется по краям суставов`)
     #### Классификация
     1. С учетом клинических симптомов, объема и вида изменений костной ткани
        - 1 стадия - внешние признаки отсутствуют, при рентгенографии патологических очагов окостенения не видно
        - 2 стадия - боль в пораженной области после физической нагрузки, резких поворотов и движений, а на снимках становятся заметными одиночные наросты и сужение суставной щели
        - 3 стадия - сопровождается выраженной симптоматикой (боли, ограничение двигательной активности, отеки), при этом на рентгеновских изображениях расстояние между суставными элементами значительно сужено, имеются признаки множественных экзостозов;
        - 4 стадия - сустав выраженно ограничен в движении, пациент испытывает постоянную боль и скованность, на снимках суставная щель отсутствует, но имеются выраженные признаки множественных остеофитов.
     2. В зависимости от причин формирования и особенностей разрастания
        - костные губчатые
        - костно-хрящевые
        - костные компактные
        - метапластические
     3. С учётом локализации
        - позвоночными
        - тазобедренными
        - шейными
        - коленными и т.д.

   * Спондилолистез (`патологическое состояние, связанное с нестабильностью позвоночника на фоне избыточной подвижности позвонков`)
   
     #### Классификация
     На основании рентгенологических данных выделяют следующие степени тяжести спондилолистеза:
     - первая степень – позвонок смещен на четверть
     - вторая степень – позвонок смещен на половину
     - третья степень – позвонок смещен на три четверти
     - четвертая степень – позвонок смещен на всем протяжении
     - пятая степень – выпадение позвонка, при котором повышается риск травматического повреждения спинного мозга


### Изображение признаков патологии
| **Остеофиты, снижение высоты межпозвоночных дисков, субхондральный склероз** | **Спондилолистез** |
|:---------:|:----------:|
|![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/other/osteokhondroz.jpg "Признаки остеохондроза: остеофиты, снижение высоты межпозвоночных дисков, субхондральный склероз") | ![alt text](https://github.com/mansvlx/X-ray-spine-instance-segmentation/blob/main/other/spondilolistez.jpg "Спондилолистез") |

### План по развитию проекта определения остеохондроза
1. Создание датасета
   - Сбор рентгеновских снимков, как отдельных отделов позвоночника(шейный, грудной и т.д.), так и нескольких участков сразу с явно и неявно видимыми признаками остехондроза
   - Сбор ренгеновских снимков с состоянием нормы
2. Нормализация и разметка датасета
   - Разметка классов признаков паталогии и класса нормы
3. Обучение нейросети
4. Создание алгоритма с подробным анализом обнаруженных признаков и дальнейшим выводом о состоянии пациента
5. Тесты продукта
6. Интеграция и коммерциализация продукта

Исходя из плана выше, должен получиться продукт содержащий алгоритм определения остеохандроза исходя из совокупности признаков и их степени проявления, а также физиологических особенностей пациента(возраст, врождённые паталогии и т.п.).
## Вывод
Таким образом, в ходе работы была обучена модель нейросети на распознавание позвонков человека, выполнены все поставленные задачи в полном объёме 
